<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="./css/style.css" type="text/css" rel="stylesheet">
    <style>
      body {
        font-size: 14px;
      }
      .bar {
        display: flex;
        justify-self: center;
        align-items: center;
        line-height: 24px;
      }
      input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }
      span {
        margin: 0 5px;
      }
      .button {
        cursor: pointer;
        line-height: 35px;
        text-align: center;
        width: 100%;
        z-index: 9;
        margin-top: 20px;
        font-size: 16px;
        background-color: #454545;
      }
      .button:hover {
        background-color: #6b6b6b;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="bar">
        <span>导出文字</span>
        <input type="checkbox" id="outText" name="outText"/>
        <span>资源命名</span>
        <select id="resOutType">
          <option value="id">图层ID</option>
          <option value="name">图层名称</option>
          <option value="group-name">组名-图层名称</option>
        </select>
      </div>
      <div class="bar">
        <span>资源前缀</span>
        <input id="resPrefix" type="text"></input>
      </div>
      <div class="bar">
        <span>资源压缩等级</span>
        <select id="compression">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2" selected="selected">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
        </select>
      </div>
      <div class="bar">
        <span>使用png8</span>
        <input type="checkbox" id="png8" name="png8"/>
      </div>
      <div class="button" onclick="outPutHTML()">导出</div>
    </div>

    <script type="text/javascript" src="./js/CSInterface.js"></script>
    <script>
      //js和jsx的交互接口
      var cs = new CSInterface();


      function loadJSX(fileName) {
        var extensionRoot = cs.getSystemPath(SystemPath.EXTENSION) + "/jsx/";
        cs.evalScript('$.evalFile("' + extensionRoot + fileName + '")');
      }

      loadJSX("json2.js");

      function outPutHTML () {
        let replaceData = ''
        let outPutText = document.getElementById('outText').checked
        if (outPutText) replaceData += 'const outPutText = true\r\n'
        else replaceData += 'const outPutText = false\r\n'
        const resOutType = document.getElementById('resOutType').value
        const resPrefix = document.getElementById('resPrefix').value
        // 图片质量
        const compression = document.getElementById('compression').value
        const png8 = document.getElementById('png8').checked
        // 插件目录
        const plugPath = cs.getSystemPath(SystemPath.EXTENSION)
        // 模板文件
        let template = window.cep.fs.readFile(plugPath + '/template.html').data
        
        
        var selectPath = window.cep.fs.showOpenDialog(false, true, "选择输出目录", "", "").data
        // 判断用户是否选择了输出目录
        if (selectPath) {
          //执行main.jsx里面定义的creatNewDocument() 方法
          cs.evalScript(`getTree('${selectPath}/', ${outPutText}, '${resOutType}', '${resPrefix}', ${compression}, ${png8})`, function (data) {
            replaceData += `const infoData = ${data}`
            // 为模板添加配置信息
            template = template.replace('// <!-- script-output -->', replaceData)
            var result = window.cep.fs.writeFile(selectPath + "/index.html", template);
            if (result.err == 0) {
              alert('生成成功!')
            }
            else {
              alert('输出失败!')
            }
          });
        }
      }

      cs.addEventListener("log", function (Event) {
        document.write(JSON.stringify(Event.data))
      });

    </script>
  </body>
</html>
